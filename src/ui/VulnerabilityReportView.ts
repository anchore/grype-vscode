import * as vscode from "vscode";
import fs = require("fs");
import { IGrypeFinding } from "../IGrypeFinding";
import { IMessage } from "../IMessage";

export class VulnerabilityReportView {
  private readonly context: vscode.ExtensionContext;
  private readonly nonce: string;
  private readonly getScanReport: () => IGrypeFinding[] | null;
  private panel: vscode.WebviewPanel | null = null;

  constructor(
    context: vscode.ExtensionContext,
    getScanReport: () => IGrypeFinding[] | null
  ) {
    this.context = context;
    this.getScanReport = getScanReport;
    this.nonce = VulnerabilityReportView.getNonce();
  }

  public async open(findings: IGrypeFinding[] | null = null): Promise<void> {
    if (this.panel === null) {
      this.panel = vscode.window.createWebviewPanel(
        "grypeVulnerabilityReport",
        "Grype Vulnerability Report",
        vscode.ViewColumn.Active,
        {
          localResourceRoots: [vscode.Uri.file(this.context.extensionPath)],
          enableScripts: true,
        }
      );

      this.initializePanel();
    } else {
      this.panel.reveal();
    }

    if (findings) {
      await this.setFindings(findings);
    }
  }

  public async setFindings(findings: IGrypeFinding[]): Promise<void> {
    if (this.panel) {
      const message: IMessage<IGrypeFinding[]> = {
        command: "update",
        payload: findings,
      };

      await this.panel.webview.postMessage(message);
    }
  }

  public set Panel(panel: vscode.WebviewPanel) {
    this.panel = panel;
    this.initializePanel();
  }

  private static getNonce(): string {
    let text = "";
    const possible =
      "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    for (let i = 0; i < 32; i++) {
      text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
  }

  private initializePanel(): void {
    if (this.panel) {
      this.panel.onDidDispose(() => {
        this.panel = null;
      });

      this.panel.onDidChangeViewState((e) => {
        const panel = e.webviewPanel;

        if (panel.active) {
          const findings = this.getScanReport();
          if (findings) {
            this.setFindings(findings);
          }
        }
      });

      this.panel.webview.html = this.templateSubstitutions(
        fs.readFileSync(
          vscode.Uri.joinPath(
            this.context.extensionUri,
            "src",
            "ui",
            "webview-assets",
            "VulnerabilityReportView.html"
          ).fsPath,
          "utf-8"
        )
      );

      this.panel.webview.onDidReceiveMessage((message: IMessage<string>) => {
        switch (message.command) {
          case "openFile":
            vscode.window.showTextDocument(vscode.Uri.parse(message.payload));
        }
      });
    }
  }

  private uiDirectory(): vscode.Uri {
    return vscode.Uri.joinPath(this.context.extensionUri, "src", "ui").with({
      scheme: "vscode-resource",
    });
  }

  private bundleDirectory(): vscode.Uri {
    return vscode.Uri.joinPath(this.context.extensionUri, "dist").with({
      scheme: "vscode-resource",
    });
  }

  private templateSubstitutions(input: string): string {
    let cspSource = "";

    if (this.panel) {
      cspSource = this.panel.webview.cspSource;
    }

    const substitutions: { find: string; replaceWith: string }[] = [
      { find: "ui", replaceWith: this.uiDirectory().toString() },
      { find: "bundle", replaceWith: this.bundleDirectory().toString() },
      { find: "webview.cspSource", replaceWith: cspSource },
      { find: "nonce", replaceWith: this.nonce },
    ];

    let output = input;

    substitutions.forEach((s) => {
      output = output.split(`[[${s.find}]]`).join(s.replaceWith);
    });

    return output;
  }
}
